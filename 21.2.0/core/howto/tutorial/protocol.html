<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>The Evolution of Finger: adding features to the finger service &mdash; Twisted 21.2.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/twistedtrac.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '21.2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="top" title="Twisted 21.2.0 documentation" href="../../../index.html" />
    <link rel="up" title="Twisted from Scratch, or The Evolution of Finger" href="index.html" />
    <link rel="next" title="The Evolution of Finger: cleaning up the finger code" href="style.html" />
    <link rel="prev" title="The Evolution of Finger: building a simple finger service" href="intro.html" /> 

  </head>
  
  
<body>

<div id="banner">
<div id="top_grad">
         
</div>
<div id="tab">
        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
    <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
    <a href="/">DOCS</a>
    <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>

</div>
      <div id="header">
        <a id="logo" href="https://twistedmatrix.com/trac/"><img src="../../../_static/trac_banner.png" alt="Twisted" /></a>
      </div>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <form id="topsearch" action="/trac/search" method="get"><div>
        <label for="proj-search">Search:</label>
        <input type="text" id="proj-search" name="q" size="10" value="" />
        <input type="submit" value="Search" />
        <input type="hidden" name="wiki" value="on" />

        <input type="hidden" name="changeset" value="on" />
        <input type="hidden" name="ticket" value="on" />
      </div></form>
      -->
      <div id="metanav" class="nav">
    <ul>
      <li> </li>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <li class="first">logged in as khorn</li><li class=""><a href="/trac/logout">Logout</a></li><li class=""><a href="/trac/wiki/TracGuide">Help/Guide</a></li><li class=""><a href="/trac/about">About Trac</a></li><li class="last"><a href="/trac/account">My Account</a></li>
      -->
    </ul>
  </div>
    </div>

<!-- mainnav -->
    <div id="mainnav" class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="style.html" title="The Evolution of Finger: cleaning up the finger code"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="intro.html" title="The Evolution of Finger: building a simple finger service"
             accesskey="P">previous</a> |</li>
        <li><a href="../../../index.html">Twisted 21.2.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Twisted Core</a> &raquo;</li>
          <li><a href="../index.html" >Developer Guides</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Twisted from Scratch, or The Evolution of Finger</a> &raquo;</li> 
      </ul>
    </div>

    <div id="main">
    <div id="ctxtnav" class="nav">
      <h2>Wiki Navigation</h2>
      <ul>
        <li>
        
        </li>
        <!-- taking this out for now, but might use 
             the space for something else later 
        -->
        <!--
        <li><a href="/trac/wiki/WikiStart">Start Page</a></li>
        <li><a href="/trac/wiki/TitleIndex">Index by Title</a></li>

        <li><a href="/trac/wiki/RecentChanges">Index by Date</a></li>
        <li class="last">
          <a href="/trac/wiki/Documentation?action=diff&amp;version=15">Last Change</a>
        </li>
        -->
      </ul>
      <hr />
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div id="current-docs-container" style="display: none">
            <em>
              <a id="current-docs-link">
                Go to the latest version of this document.
              </a>
            </em>
          </div>
          <div class="body">
            
  <div class="section" id="the-evolution-of-finger-adding-features-to-the-finger-service">
<h1>The Evolution of Finger: adding features to the finger service<a class="headerlink" href="#the-evolution-of-finger-adding-features-to-the-finger-service" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This is the second part of the Twisted tutorial <a class="reference internal" href="index.html"><span class="doc">Twisted from Scratch, or The Evolution of Finger</span></a> .</p>
<p>In this section of the tutorial, our finger server will continue to sprout
features: the ability for users to set finger announces, and using our finger
service to send those announcements on the web, on IRC and over XML-RPC.
Resources and XML-RPC are introduced in the Web Applications portion of
the <a class="reference internal" href="../../../web/howto/index.html"><span class="doc">Twisted Web howto</span></a> . More examples
using <a class="reference external" href="/documents/21.2.0/api/twisted.words.protocols.irc.html" title="(in twisted v2.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.words.protocols.irc</span></code></a> can be found
in <a class="reference internal" href="../clients.html"><span class="doc">Writing a TCP Client</span></a> and
the <a class="reference internal" href="../../../words/examples/index.html"><span class="doc">Twisted Words examples</span></a> .</p>
</div>
<div class="section" id="setting-message-by-local-users">
<h2>Setting Message By Local Users<a class="headerlink" href="#setting-message-by-local-users" title="Permalink to this headline">¶</a></h2>
<p>Now that port 1079 is free, maybe we can use it with a different
server, one which will let people set their messages. It does
no access control, so anyone who can login to the machine can
set any message. We assume this is the desired behavior in
our case. Testing it can be done by simply:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">% </span>nc localhost <span class="m">1079</span>   <span class="c1"># or telnet localhost 1079</span>
<span class="go">moshez</span>
<span class="go">Giving a tutorial now, sorry!</span>
<span class="go">^D</span>
</pre></div>
</div>
<p><a class="reference download internal" download="" href="../../../_downloads/875bcd74c07dd9846750f1b4ff8b6cf3/finger12.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger12.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># But let&#39;s try and fix setting away messages, shall we?</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">FingerSetterProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">setUser</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerSetterFactory</span><span class="p">(</span><span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">):</span>
    <span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerSetterProtocol</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fingerFactory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fingerFactory</span> <span class="o">=</span> <span class="n">fingerFactory</span>

    <span class="k">def</span> <span class="nf">setUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fingerFactory</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>


<span class="n">ff</span> <span class="o">=</span> <span class="n">FingerFactory</span><span class="p">({</span><span class="sa">b</span><span class="s2">&quot;moshez&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;Happy and well&quot;</span><span class="p">})</span>
<span class="n">fsf</span> <span class="o">=</span> <span class="n">FingerSetterFactory</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">serviceCollection</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">ff</span><span class="p">)</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:1079&quot;</span><span class="p">,</span> <span class="n">fsf</span><span class="p">)</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
</pre></div>
</div>
<p>This program has two protocol-factory-TCPServer pairs, which are
both child services of the application.  Specifically,
the <a class="reference external" href="/documents/21.2.0/api/twisted.application.service.Service.html#setServiceParent" title="(in twisted v2.0)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">setServiceParent</span></code></a>
method is used to define the two TCPServer services as children
of <code class="docutils literal notranslate"><span class="pre">application</span></code> , which implements <a class="reference external" href="/documents/21.2.0/api/twisted.application.service.IServiceCollection.html" title="(in twisted v2.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">IServiceCollection</span></code></a> .  Both
services are thus started with the application.</p>
</div>
<div class="section" id="use-services-to-make-dependencies-sane">
<h2>Use Services to Make Dependencies Sane<a class="headerlink" href="#use-services-to-make-dependencies-sane" title="Permalink to this headline">¶</a></h2>
<p>The previous version had the setter poke at the innards of the
finger factory. This strategy is usually not a good idea: this version makes
both factories symmetric by making them both look at a single
object. Services are useful for when an object is needed which is
not related to a specific network server. Here, we define a common service
class with methods that will create factories on the fly. The service
also contains methods the factories will depend on.</p>
<p>The factory-creation methods, <code class="docutils literal notranslate"><span class="pre">getFingerFactory</span></code>
and <code class="docutils literal notranslate"><span class="pre">getFingerSetterFactory</span></code> , follow this pattern:</p>
<ol class="arabic simple">
<li><p>Instantiate a generic server
factory, <code class="docutils literal notranslate"><span class="pre">twisted.internet.protocol.ServerFactory</span></code> .</p></li>
<li><p>Set the protocol class, just like our factory class would have.</p></li>
<li><p>Copy a service method to the factory as a function attribute.  The
function won’t have access to the factory’s <code class="docutils literal notranslate"><span class="pre">self</span></code> , but
that’s OK because as a bound method it has access to the
service’s <code class="docutils literal notranslate"><span class="pre">self</span></code> , which is what it needs.
For <code class="docutils literal notranslate"><span class="pre">getUser</span></code> , a custom method defined in the service gets
copied.  For <code class="docutils literal notranslate"><span class="pre">setUser</span></code> , a standard method of
the <code class="docutils literal notranslate"><span class="pre">users</span></code> dictionary is copied.</p></li>
</ol>
<p>Thus, we stopped subclassing: the service simply puts useful methods and
attributes inside the factories. We are getting better at protocol design:
none of our protocol classes had to be changed, and neither will have to
change until the end of the tutorial.</p>
<p>As an application service, this new finger service implements the <a class="reference external" href="/documents/21.2.0/api/twisted.application.service.IService.html" title="(in twisted v2.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">IService</span></code></a> interface and
can be started and stopped in a standardized manner. We’ll make use of this in
the next example.</p>
<p><a class="reference download internal" download="" href="../../../_downloads/a1917c80ba5b4bb21cb7b9537d284844/finger13.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger13.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fix asymmetry</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerSetterProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connectionLost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">setUser</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">setUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>

    <span class="k">def</span> <span class="nf">getFingerFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">getFingerSetterFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerSetterProtocol</span>
        <span class="n">f</span><span class="o">.</span><span class="n">setUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setUser</span>
        <span class="k">return</span> <span class="n">f</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">FingerService</span><span class="p">({</span><span class="sa">b</span><span class="s2">&quot;moshez&quot;</span><span class="p">:</span> <span class="sa">b</span><span class="s2">&quot;Happy and well&quot;</span><span class="p">})</span>
<span class="n">serviceCollection</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getFingerFactory</span><span class="p">())</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:1079&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getFingerSetterFactory</span><span class="p">())</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span>
    <span class="n">serviceCollection</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Most application services will want to use the <a class="reference external" href="/documents/21.2.0/api/twisted.application.service.Service.html" title="(in twisted v2.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Service</span></code></a> base class, which implements
all the generic <code class="docutils literal notranslate"><span class="pre">IService</span></code> behavior.</p>
</div>
<div class="section" id="read-status-file">
<h2>Read Status File<a class="headerlink" href="#read-status-file" title="Permalink to this headline">¶</a></h2>
<p>This version shows how, instead of just letting users set their
messages, we can read those from a centrally managed file. We cache
results, and every 30 seconds we refresh it. Services are useful
for such scheduled tasks.</p>
<p>listings/finger/etc.users</p>
<p><a class="reference download internal" download="" href="../../../_downloads/50a6b4b1f7af8f2a6821a6ca09589958/finger14.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger14.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read from file</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getFingerFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">FingerService</span><span class="p">(</span><span class="s2">&quot;/etc/users&quot;</span><span class="p">)</span>
<span class="n">finger</span> <span class="o">=</span> <span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getFingerFactory</span><span class="p">())</span>

<span class="n">finger</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
<span class="n">f</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">))</span>
</pre></div>
</div>
<p>Since this version is reading data from a file (and refreshing the data
every 30 seconds), there is no <code class="docutils literal notranslate"><span class="pre">FingerSetterFactory</span></code> and thus
nothing listening on port 1079.</p>
<p>Here we override the standard <a class="reference external" href="/documents/21.2.0/api/twisted.application.service.Service.html#startService" title="(in twisted v2.0)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">startService</span></code></a>
and <a class="reference external" href="/documents/21.2.0/api/twisted.application.service.Service.html#stopService" title="(in twisted v2.0)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">stopService</span></code></a> hooks in
the Finger service, which is set up as a child service of the
application in the last line of the code. <code class="docutils literal notranslate"><span class="pre">startService</span></code>
calls <code class="docutils literal notranslate"><span class="pre">_read</span></code> , the function responsible for reading the
data; <code class="docutils literal notranslate"><span class="pre">reactor.callLater</span></code> is then used to schedule it to
run again after thirty seconds every time it is
called. <code class="docutils literal notranslate"><span class="pre">reactor.callLater</span></code> returns an object that lets us
cancel the scheduled run in <code class="docutils literal notranslate"><span class="pre">stopService</span></code> using
its <code class="docutils literal notranslate"><span class="pre">cancel</span></code> method.</p>
</div>
<div class="section" id="announce-on-web-too">
<h2>Announce on Web, Too<a class="headerlink" href="#announce-on-web-too" title="Permalink to this headline">¶</a></h2>
<p>The same kind of service can also produce things useful for other
protocols. For example, in twisted.web, the factory itself
(<code class="docutils literal notranslate"><span class="pre">Site</span></code> ) is almost
never subclassed — instead, it is given a resource, which
represents the tree of resources available via URLs. That hierarchy is
navigated by <code class="docutils literal notranslate"><span class="pre">Site</span></code>
and overriding it dynamically is possible with <code class="docutils literal notranslate"><span class="pre">getChild</span></code> .</p>
<p>To integrate this into the Finger application (just because we can), we set
up a new TCPServer that calls the <code class="docutils literal notranslate"><span class="pre">Site</span></code> factory and retrieves resources via a
new function of <code class="docutils literal notranslate"><span class="pre">FingerService</span></code> named <code class="docutils literal notranslate"><span class="pre">getResource</span></code> .
This function specifically returns a <code class="docutils literal notranslate"><span class="pre">Resource</span></code> object with an overridden <code class="docutils literal notranslate"><span class="pre">getChild</span></code> method.</p>
<p><a class="reference download internal" download="" href="../../../_downloads/20b4de82e40fbfc23a74c7c153edf552/finger15.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger15.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read from file, announce on the web!</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">resource</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">static</span>
<span class="kn">import</span> <span class="nn">cgi</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerResource</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">users</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="n">users</span>
        <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c1"># we treat the path as the username</span>
    <span class="k">def</span> <span class="nf">getChild</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &#39;username&#39; is L{bytes}.</span>
<span class="sd">        &#39;request&#39; is a &#39;twisted.web.server.Request&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">messagevalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">messagevalue</span><span class="p">:</span>
            <span class="n">messagevalue</span> <span class="o">=</span> <span class="n">messagevalue</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">messagevalue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">messagevalue</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">messagevalue</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;</span><span class="si">{}</span><span class="s2">&lt;/h1&gt;&lt;p&gt;</span><span class="si">{}</span><span class="s2">&lt;/p&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">messagevalue</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;</span><span class="si">{}</span><span class="s2">&lt;/h1&gt;&lt;p&gt;No such user&lt;/p&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">static</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getFingerFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">getResource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">FingerResource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">FingerService</span><span class="p">(</span><span class="s2">&quot;/etc/users&quot;</span><span class="p">)</span>
<span class="n">serviceCollection</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getFingerFactory</span><span class="p">())</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:8000&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">Site</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getResource</span><span class="p">()))</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span>
    <span class="n">serviceCollection</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="announce-on-irc-too">
<h2>Announce on IRC, Too<a class="headerlink" href="#announce-on-irc-too" title="Permalink to this headline">¶</a></h2>
<p>This is the first time there is client code. IRC clients often act a lot like
servers: responding to events from the network.  The Client Service will make
sure that severed links will get re-established, with intelligent
tweaked exponential back-off algorithms. The IRC client itself is simple: the
only real hack is getting the nickname from the factory
in <code class="docutils literal notranslate"><span class="pre">connectionMade</span></code> .</p>
<p><a class="reference download internal" download="" href="../../../_downloads/2987d2ae796e5b4b6c718927c7f30d02/finger16.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger16.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read from file, announce on the web, irc</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">internet</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span><span class="p">,</span> <span class="n">endpoints</span>
<span class="kn">from</span> <span class="nn">twisted.words.protocols</span> <span class="kn">import</span> <span class="n">irc</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">resource</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">static</span>

<span class="kn">import</span> <span class="nn">cgi</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IRCReplyBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">nickname</span>
        <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">channel</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

            <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
                <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getFingerFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">getResource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such users &lt;p/&gt; usage: site/user&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;</span><span class="si">{}</span><span class="s2">&lt;/h1&gt;&lt;p&gt;</span><span class="si">{}</span><span class="s2">&lt;/p&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">static</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">getChild</span> <span class="o">=</span> <span class="n">getData</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">getIRCBot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nickname</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IRCReplyBot</span>
        <span class="n">f</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">nickname</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">FingerService</span><span class="p">(</span><span class="s2">&quot;/etc/users&quot;</span><span class="p">)</span>
<span class="n">serviceCollection</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getFingerFactory</span><span class="p">())</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:8000&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">Site</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getResource</span><span class="p">()))</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span>
    <span class="n">serviceCollection</span>
<span class="p">)</span>
<span class="n">internet</span><span class="o">.</span><span class="n">ClientService</span><span class="p">(</span>
    <span class="n">endpoints</span><span class="o">.</span><span class="n">clientFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:irc.freenode.org:6667&quot;</span><span class="p">),</span>
    <span class="n">f</span><span class="o">.</span><span class="n">getIRCBot</span><span class="p">(</span><span class="s2">&quot;fingerbot&quot;</span><span class="p">),</span>
<span class="p">)</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">FingerService</span></code> now has another new
function, <code class="docutils literal notranslate"><span class="pre">getIRCbot</span></code> , which returns
a <code class="docutils literal notranslate"><span class="pre">ClientFactory</span></code> .  This factory in turn will
instantiate the <code class="docutils literal notranslate"><span class="pre">IRCReplyBot</span></code> protocol.  The IRCBot is
configured in the last line to connect
to <code class="docutils literal notranslate"><span class="pre">irc.freenode.org</span></code> with a nickname
of <code class="docutils literal notranslate"><span class="pre">fingerbot</span></code> .</p>
<p>By
overriding <code class="docutils literal notranslate"><span class="pre">irc.IRCClient.connectionMade</span></code> , <code class="docutils literal notranslate"><span class="pre">IRCReplyBot</span></code>
can access the <code class="docutils literal notranslate"><span class="pre">nickname</span></code> attribute of the factory that
instantiated it.</p>
</div>
<div class="section" id="add-xml-rpc-support">
<h2>Add XML-RPC Support<a class="headerlink" href="#add-xml-rpc-support" title="Permalink to this headline">¶</a></h2>
<p>In Twisted, XML-RPC support is handled just as though it was
another resource. That resource will still support GET calls normally
through render(), but that is usually left unimplemented. Note
that it is possible to return deferreds from XML-RPC methods.
The client, of course, will not get the answer until the deferred
is triggered.</p>
<p><a class="reference download internal" download="" href="../../../_downloads/9062ebd46a3dbc7c12ca7389d0d7cfb4/finger17.tac"><code class="xref download docutils literal notranslate"><span class="pre">finger17.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read from file, announce on the web, irc, xml-rpc</span>
<span class="kn">from</span> <span class="nn">twisted.application</span> <span class="kn">import</span> <span class="n">internet</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">strports</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">reactor</span><span class="p">,</span> <span class="n">defer</span><span class="p">,</span> <span class="n">endpoints</span>
<span class="kn">from</span> <span class="nn">twisted.words.protocols</span> <span class="kn">import</span> <span class="n">irc</span>
<span class="kn">from</span> <span class="nn">twisted.protocols</span> <span class="kn">import</span> <span class="n">basic</span>
<span class="kn">from</span> <span class="nn">twisted.web</span> <span class="kn">import</span> <span class="n">resource</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">static</span><span class="p">,</span> <span class="n">xmlrpc</span>
<span class="kn">import</span> <span class="nn">cgi</span>


<span class="k">class</span> <span class="nc">FingerProtocol</span><span class="p">(</span><span class="n">basic</span><span class="o">.</span><span class="n">LineReceiver</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">lineReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">b</span><span class="s2">&quot;Internal error in server&quot;</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&quot;</span><span class="se">\r\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">loseConnection</span><span class="p">()</span>

        <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IRCReplyBot</span><span class="p">(</span><span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">nickname</span>
        <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">connectionMade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">privmsg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nickname</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">channel</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factory</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span>

            <span class="k">def</span> <span class="nf">onError</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;Internal error in server&quot;</span>

            <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">onError</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">writeResponse</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
                <span class="n">irc</span><span class="o">.</span><span class="n">IRCClient</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;: &quot;</span> <span class="o">+</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">writeResponse</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FingerService</span><span class="p">(</span><span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">user</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span> <span class="o">=</span> <span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getUser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">defer</span><span class="o">.</span><span class="n">succeed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getFingerFactory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ServerFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">FingerProtocol</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">getResource</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">getData</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;No such user &lt;p/&gt; usage: site/user&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&lt;h1&gt;</span><span class="si">{}</span><span class="s2">&lt;/h1&gt;&lt;p&gt;</span><span class="si">{}</span><span class="s2">&lt;/p&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">static</span><span class="o">.</span><span class="n">Data</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">Resource</span><span class="p">()</span>
        <span class="n">r</span><span class="o">.</span><span class="n">getChild</span> <span class="o">=</span> <span class="n">getData</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">xmlrpc</span><span class="o">.</span><span class="n">XMLRPC</span><span class="p">()</span>
        <span class="n">x</span><span class="o">.</span><span class="n">xmlrpc_getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="n">r</span><span class="o">.</span><span class="n">putChild</span><span class="p">(</span><span class="s2">&quot;RPC2&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r</span>

    <span class="k">def</span> <span class="nf">getIRCBot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nickname</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">protocol</span><span class="o">.</span><span class="n">ClientFactory</span><span class="p">()</span>
        <span class="n">f</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">IRCReplyBot</span>
        <span class="n">f</span><span class="o">.</span><span class="n">nickname</span> <span class="o">=</span> <span class="n">nickname</span>
        <span class="n">f</span><span class="o">.</span><span class="n">getUser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getUser</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">def</span> <span class="nf">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">()</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">startService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">service</span><span class="o">.</span><span class="n">Service</span><span class="o">.</span><span class="n">stopService</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>


<span class="n">application</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="s2">&quot;finger&quot;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">FingerService</span><span class="p">(</span><span class="s2">&quot;/etc/users&quot;</span><span class="p">)</span>
<span class="n">serviceCollection</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="n">IServiceCollection</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:79&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">getFingerFactory</span><span class="p">())</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
<span class="n">strports</span><span class="o">.</span><span class="n">service</span><span class="p">(</span><span class="s2">&quot;tcp:8000&quot;</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">Site</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">getResource</span><span class="p">()))</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span>
    <span class="n">serviceCollection</span>
<span class="p">)</span>
<span class="n">internet</span><span class="o">.</span><span class="n">ClientService</span><span class="p">(</span>
    <span class="n">endpoints</span><span class="o">.</span><span class="n">clientFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tcp:irc.freenode.org:6667&quot;</span><span class="p">),</span>
    <span class="n">f</span><span class="o">.</span><span class="n">getIRCBot</span><span class="p">(</span><span class="s2">&quot;fingerbot&quot;</span><span class="p">),</span>
<span class="p">)</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">serviceCollection</span><span class="p">)</span>
</pre></div>
</div>
<p>Instead of a web browser, we can test the XMLRPC finger using a simple
client based on Python’s built-in <code class="docutils literal notranslate"><span class="pre">xmlrpclib</span></code> , which will access
the resource we’ve made available at <code class="docutils literal notranslate"><span class="pre">localhost/RPC2</span></code> .</p>
<p><a class="reference download internal" download="" href="../../../_downloads/d79a2e4101b1c7f1fa30cfbbb1d99a65/fingerXRclient.py"><code class="xref download docutils literal notranslate"><span class="pre">fingerXRclient.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># testing xmlrpc finger</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Python 3</span>
    <span class="kn">from</span> <span class="nn">xmlrpc.client</span> <span class="kn">import</span> <span class="n">Server</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># Python 2</span>
    <span class="kn">from</span> <span class="nn">xmlrpclib</span> <span class="kn">import</span> <span class="n">Server</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">Server</span><span class="p">(</span><span class="s2">&quot;http://127.0.0.1:8000/RPC2&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">server</span><span class="o">.</span><span class="n">getUser</span><span class="p">(</span><span class="s2">&quot;moshez&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">The Evolution of Finger: adding features to the finger service</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#setting-message-by-local-users">Setting Message By Local Users</a></li>
<li><a class="reference internal" href="#use-services-to-make-dependencies-sane">Use Services to Make Dependencies Sane</a></li>
<li><a class="reference internal" href="#read-status-file">Read Status File</a></li>
<li><a class="reference internal" href="#announce-on-web-too">Announce on Web, Too</a></li>
<li><a class="reference internal" href="#announce-on-irc-too">Announce on IRC, Too</a></li>
<li><a class="reference internal" href="#add-xml-rpc-support">Add XML-RPC Support</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="intro.html"
                                  title="previous chapter">The Evolution of Finger: building a simple finger service</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="style.html"
                                  title="next chapter">The Evolution of Finger: cleaning up the finger code</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../../_sources/core/howto/tutorial/protocol.rst.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../../search.html" method="get">
                <p>
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                </p>
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    </div>
    <div id="footer"><hr />
      <div>

</div>
      <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

      </p>
      <p class="right"></p>
    </div>
    <script type="text/javascript">
      if (window.location.pathname.indexOf('/current/') == -1) {
          <!-- Give the user a link to this page, but in the current version of the docs. -->
          var link = document.getElementById('current-docs-link');
          link.href = window.location.pathname.replace(/\/\d+\.\d+\.\d+/, '/current');
          <!-- And make it visible -->
          var container = document.getElementById('current-docs-container');
          container.style.display = '';
          delete link;
          delete container;
      }
    </script>
  </body>
</html>