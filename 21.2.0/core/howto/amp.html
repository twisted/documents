<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Asynchronous Messaging Protocol Overview &mdash; Twisted 21.2.0 documentation</title>
    <link rel="stylesheet" href="../../_static/twistedtrac.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '21.2.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Twisted 21.2.0 documentation" href="../../index.html" />
    <link rel="up" title="Developer Guides" href="index.html" />
    <link rel="next" title="Overview of Twisted Spread" href="pb.html" />
    <link rel="prev" title="Extremely Low-Level Socket Operations" href="sendmsg.html" /> 

  </head>
  
  
<body>

<div id="banner">
<div id="top_grad">
         
</div>
<div id="tab">
        <a href="https://twistedmatrix.com/trac/wiki">HOME</a>
    <a href="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
    <a href="/">DOCS</a>
    <a href="https://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>

</div>
      <div id="header">
        <a id="logo" href="https://twistedmatrix.com/trac/"><img src="../../_static/trac_banner.png" alt="Twisted" /></a>
      </div>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <form id="topsearch" action="/trac/search" method="get"><div>
        <label for="proj-search">Search:</label>
        <input type="text" id="proj-search" name="q" size="10" value="" />
        <input type="submit" value="Search" />
        <input type="hidden" name="wiki" value="on" />

        <input type="hidden" name="changeset" value="on" />
        <input type="hidden" name="ticket" value="on" />
      </div></form>
      -->
      <div id="metanav" class="nav">
    <ul>
      <li> </li>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <li class="first">logged in as khorn</li><li class=""><a href="/trac/logout">Logout</a></li><li class=""><a href="/trac/wiki/TracGuide">Help/Guide</a></li><li class=""><a href="/trac/about">About Trac</a></li><li class="last"><a href="/trac/account">My Account</a></li>
      -->
    </ul>
  </div>
    </div>

<!-- mainnav -->
    <div id="mainnav" class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pb.html" title="Overview of Twisted Spread"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="sendmsg.html" title="Extremely Low-Level Socket Operations"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Twisted 21.2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Twisted Core</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Developer Guides</a> &raquo;</li> 
      </ul>
    </div>

    <div id="main">
    <div id="ctxtnav" class="nav">
      <h2>Wiki Navigation</h2>
      <ul>
        <li>
        
        </li>
        <!-- taking this out for now, but might use 
             the space for something else later 
        -->
        <!--
        <li><a href="/trac/wiki/WikiStart">Start Page</a></li>
        <li><a href="/trac/wiki/TitleIndex">Index by Title</a></li>

        <li><a href="/trac/wiki/RecentChanges">Index by Date</a></li>
        <li class="last">
          <a href="/trac/wiki/Documentation?action=diff&amp;version=15">Last Change</a>
        </li>
        -->
      </ul>
      <hr />
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div id="current-docs-container" style="display: none">
            <em>
              <a id="current-docs-link">
                Go to the latest version of this document.
              </a>
            </em>
          </div>
          <div class="body">
            
  <div class="section" id="asynchronous-messaging-protocol-overview">
<h1>Asynchronous Messaging Protocol Overview<a class="headerlink" href="#asynchronous-messaging-protocol-overview" title="Permalink to this headline">¶</a></h1>
<p>The purpose of this guide is to describe the uses for and usage of <a class="reference external" href="/documents/21.2.0/api/twisted.protocols.amp.html" title="(in twisted v2.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">twisted.protocols.amp</span></code></a> beyond what is explained in the API documentation.  It will show you how to implement an AMP server which can respond to commands or interact directly with individual messages.  It will also show you how to implement an AMP client which can issue commands to a server.</p>
<p>AMP is a bidirectional command/response-oriented protocol intended to be extended with application-specific request types and handlers.  Various simple data types are supported and support for new data types can be added by applications.</p>
<div class="section" id="setting-up">
<h2>Setting Up<a class="headerlink" href="#setting-up" title="Permalink to this headline">¶</a></h2>
<p>AMP runs over a stream-oriented connection-based protocol, such as TCP or SSL.  Before you can use any features of the AMP protocol, you need a connection.  The protocol class to use to establish an AMP connection is <a class="reference external" href="/documents/21.2.0/api/twisted.protocols.amp.AMP.html" title="(in twisted v2.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">AMP</span></code></a> .  Connection setup works as it does for almost all protocols in Twisted.  For example, you can set up a listening AMP server using a server endpoint:</p>
<p><a class="reference download internal" download="" href="../../_downloads/0e696784302105e2387500d21a0cb23f/basic_server.tac"><code class="xref download docutils literal notranslate"><span class="pre">basic_server.tac</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">AMP</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">TCP4ServerEndpoint</span>
<span class="kn">from</span> <span class="nn">twisted.application.service</span> <span class="kn">import</span> <span class="n">Application</span>
<span class="kn">from</span> <span class="nn">twisted.application.internet</span> <span class="kn">import</span> <span class="n">StreamServerEndpointService</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">Application</span><span class="p">(</span><span class="s2">&quot;basic AMP server&quot;</span><span class="p">)</span>

<span class="n">endpoint</span> <span class="o">=</span> <span class="n">TCP4ServerEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="mi">8750</span><span class="p">)</span>
<span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
<span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">AMP</span>
<span class="n">service</span> <span class="o">=</span> <span class="n">StreamServerEndpointService</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">factory</span><span class="p">)</span>
<span class="n">service</span><span class="o">.</span><span class="n">setServiceParent</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
</pre></div>
</div>
<p>And you can connect to an AMP server using a client endpoint:</p>
<p><a class="reference download internal" download="" href="../../_downloads/d7013ef6d94e4079442435461e90d8f2/basic_client.py"><code class="xref download docutils literal notranslate"><span class="pre">basic_client.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">basic_client</span>

    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">basic_client</span><span class="o">.</span><span class="n">main</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>

<span class="kn">from</span> <span class="nn">twisted.python.log</span> <span class="kn">import</span> <span class="n">startLogging</span><span class="p">,</span> <span class="n">err</span>
<span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">AMP</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">TCP4ClientEndpoint</span>


<span class="k">def</span> <span class="nf">connect</span><span class="p">():</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="n">TCP4ClientEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">8750</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Factory</span><span class="o">.</span><span class="n">forProtocol</span><span class="p">(</span><span class="n">AMP</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">startLogging</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">connect</span><span class="p">()</span>
    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">&quot;Connection failed&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="n">ignored</span><span class="p">):</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="commands">
<h2>Commands<a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h2>
<p>Either side of an AMP connection can issue a command to the other side.  Each kind of command is represented as a subclass of <a class="reference external" href="/documents/21.2.0/api/twisted.protocols.amp.Command.html" title="(in twisted v2.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Command</span></code></a> .  A <code class="docutils literal notranslate"><span class="pre">Command</span></code> defines arguments, response values, and error conditions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">Command</span>

<span class="k">class</span> <span class="nc">UsernameUnavailable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">RegisterUser</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">()),</span>
                 <span class="p">(</span><span class="s1">&#39;publickey&#39;</span><span class="p">,</span> <span class="n">String</span><span class="p">())]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">())]</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">UsernameUnavailable</span><span class="p">:</span> <span class="s1">&#39;username-unavailable&#39;</span><span class="p">}</span>
</pre></div>
</div>
<p>The definition of the command’s signature - its arguments, response, and possible error conditions - is separate from the implementation of the behavior to execute when the command is received.  The <code class="docutils literal notranslate"><span class="pre">Command</span></code> subclass only defines the former.</p>
<p>Commands are issued by calling <code class="docutils literal notranslate"><span class="pre">callRemote</span></code> on either side of the connection.  This method returns a <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> which eventually fires with the result of the command.</p>
<p><a class="reference download internal" download="" href="../../_downloads/d56f5f8e0047abf9df5c2057bc61ed48/command_client.py"><code class="xref download docutils literal notranslate"><span class="pre">command_client.py</span></code></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">command_client</span>

    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="n">command_client</span><span class="o">.</span><span class="n">main</span><span class="p">())</span>

<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">stdout</span>

<span class="kn">from</span> <span class="nn">twisted.python.log</span> <span class="kn">import</span> <span class="n">startLogging</span><span class="p">,</span> <span class="n">err</span>
<span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">,</span> <span class="n">Command</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="kn">from</span> <span class="nn">basic_client</span> <span class="kn">import</span> <span class="n">connect</span>


<span class="k">class</span> <span class="nc">UsernameUnavailable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span> <span class="nc">RegisterUser</span><span class="p">(</span><span class="n">Command</span><span class="p">):</span>
    <span class="n">arguments</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;username&quot;</span><span class="p">,</span> <span class="n">Unicode</span><span class="p">()),</span> <span class="p">(</span><span class="s2">&quot;publickey&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">())]</span>

    <span class="n">response</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">())]</span>

    <span class="n">errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">UsernameUnavailable</span><span class="p">:</span> <span class="s2">&quot;username-unavailable&quot;</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">startLogging</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">connect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="n">protocol</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">protocol</span><span class="o">.</span><span class="n">callRemote</span><span class="p">(</span>
            <span class="n">RegisterUser</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span>
            <span class="n">publickey</span><span class="o">=</span><span class="s2">&quot;ssh-rsa AAAAB3NzaC1yc2 alice@actinium&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">connected</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">registered</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Registration result:&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">registered</span><span class="p">)</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addErrback</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s2">&quot;Failed to register&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">finished</span><span class="p">(</span><span class="n">ignored</span><span class="p">):</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="n">d</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">finished</span><span class="p">)</span>

    <span class="n">reactor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="locators">
<h2>Locators<a class="headerlink" href="#locators" title="Permalink to this headline">¶</a></h2>
<p>The logic for handling a command can be specified as an object separate from the <code class="docutils literal notranslate"><span class="pre">AMP</span></code> instance which interprets and formats bytes over the network.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">CommandLocator</span>
<span class="kn">from</span> <span class="nn">twisted.python.filepath</span> <span class="kn">import</span> <span class="n">FilePath</span>

<span class="k">class</span> <span class="nc">UsernameUnavailable</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">UserRegistration</span><span class="p">(</span><span class="n">CommandLocator</span><span class="p">):</span>
    <span class="n">uidCounter</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="nd">@RegisterUser</span><span class="o">.</span><span class="n">responder</span>
    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">publickey</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">FilePath</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">UsernameUnavailable</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uidCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">path</span><span class="o">.</span><span class="n">setContent</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uidCounter</span><span class="p">,</span> <span class="n">publickey</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">uidCounter</span>
</pre></div>
</div>
<p>When you define a separate <code class="docutils literal notranslate"><span class="pre">CommandLocator</span></code> subclass, use it by passing an instance of it to the <code class="docutils literal notranslate"><span class="pre">AMP</span></code> initializer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
<span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">AMP</span><span class="p">(</span><span class="n">locator</span><span class="o">=</span><span class="n">UserRegistration</span><span class="p">())</span>
</pre></div>
</div>
<p>If no locator is passed in, <code class="docutils literal notranslate"><span class="pre">AMP</span></code> acts as its own locator.  Command responders can be defined on an <code class="docutils literal notranslate"><span class="pre">AMP</span></code> subclass, just as the responder was defined on the <code class="docutils literal notranslate"><span class="pre">UserRegistration</span></code> example above.</p>
</div>
<div class="section" id="box-receivers">
<h2>Box Receivers<a class="headerlink" href="#box-receivers" title="Permalink to this headline">¶</a></h2>
<p>AMP conversations consist of an exchange of messages called <em>boxes</em> .  A <em>box</em> consists of a sequence of pairs of key and value (for example, the pair <code class="docutils literal notranslate"><span class="pre">username</span></code> and <code class="docutils literal notranslate"><span class="pre">alice</span></code> ).  Boxes are generally represented as <code class="docutils literal notranslate"><span class="pre">dict</span></code> instances.  Normally boxes are passed back and forth to implement the command request/response features described above.  The logic for handling each box can be specified as an object separate from the <code class="docutils literal notranslate"><span class="pre">AMP</span></code> instance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">zope.interface</span> <span class="kn">import</span> <span class="n">implementer</span>

<span class="kn">from</span> <span class="nn">twisted.protocols.amp</span> <span class="kn">import</span> <span class="n">IBoxReceiver</span>

<span class="nd">@implementer</span><span class="p">(</span><span class="n">IBoxReceiver</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">BoxReflector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">startReceivingBoxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boxSender</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxSender</span> <span class="o">=</span> <span class="n">boxSender</span>

    <span class="k">def</span> <span class="nf">ampBoxReceived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxSender</span><span class="o">.</span><span class="n">sendBox</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">stopReceivingBoxes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boxSender</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
<p>These methods parallel those of <code class="docutils literal notranslate"><span class="pre">IProtocol</span></code> .  Startup notification is given by <code class="docutils literal notranslate"><span class="pre">startReceivingBoxes</span></code> .  The argument passed to it is an <code class="docutils literal notranslate"><span class="pre">IBoxSender</span></code> provider, which can be used to send boxes back out over the network.  <code class="docutils literal notranslate"><span class="pre">ampBoxReceived</span></code> delivers notification for a complete box having been received.  And last, <code class="docutils literal notranslate"><span class="pre">stopReceivingBoxes</span></code> notifies the object that no more boxes will be received and no more can be sent.  The argument passed to it is a <code class="docutils literal notranslate"><span class="pre">Failure</span></code> which may contain details about what caused the conversation to end.</p>
<p>To use a custom <code class="docutils literal notranslate"><span class="pre">IBoxReceiver</span></code> , pass it to the <code class="docutils literal notranslate"><span class="pre">AMP</span></code> initializer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">factory</span> <span class="o">=</span> <span class="n">Factory</span><span class="p">()</span>
<span class="n">factory</span><span class="o">.</span><span class="n">protocol</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">AMP</span><span class="p">(</span><span class="n">boxReceiver</span><span class="o">=</span><span class="n">BoxReflector</span><span class="p">())</span>
</pre></div>
</div>
<p>If no box receiver is passed in, <code class="docutils literal notranslate"><span class="pre">AMP</span></code> acts as its own box receiver.  It handles boxes by treating them as command requests or responses and delivering them to the appropriate responder or as a result to a <code class="docutils literal notranslate"><span class="pre">callRemote</span></code> <code class="docutils literal notranslate"><span class="pre">Deferred</span></code> .</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Asynchronous Messaging Protocol Overview</a><ul>
<li><a class="reference internal" href="#setting-up">Setting Up</a></li>
<li><a class="reference internal" href="#commands">Commands</a></li>
<li><a class="reference internal" href="#locators">Locators</a></li>
<li><a class="reference internal" href="#box-receivers">Box Receivers</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="sendmsg.html"
                                  title="previous chapter">Extremely Low-Level Socket Operations</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="pb.html"
                                  title="next chapter">Overview of Twisted Spread</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/core/howto/amp.rst.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search.html" method="get">
                <p>
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                </p>
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    </div>
    <div id="footer"><hr />
      <div>

</div>
      <p class="left2">
        Copyright 2021, Twisted Matrix Labs. Ver 21.2.0. Built on 2021-02-28.<br />
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

      </p>
      <p class="right"></p>
    </div>
    <script type="text/javascript">
      if (window.location.pathname.indexOf('/current/') == -1) {
          <!-- Give the user a link to this page, but in the current version of the docs. -->
          var link = document.getElementById('current-docs-link');
          link.href = window.location.pathname.replace(/\/\d+\.\d+\.\d+/, '/current');
          <!-- And make it visible -->
          var container = document.getElementById('current-docs-container');
          container.style.display = '';
          delete link;
          delete container;
      }
    </script>
  </body>
</html>