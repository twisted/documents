<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

  <head>
    <meta name="Description" content="An event-driven networking engine written in Python and MIT licensed." />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Getting Connected with Endpoints &mdash; Twisted 17.1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/twistedtrac.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '17.1.0',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="top" title="Twisted 17.1.0 documentation" href="../../index.html" />
    <link rel="up" title="Developer Guides" href="index.html" />
    <link rel="next" title="Components: Interfaces and Adapters" href="components.html" />
    <link rel="prev" title="Choosing a Reactor and GUI Toolkit Integration" href="choosing-reactor.html" /> 

  </head>
  
  
<body>

<div id="banner">
<div id="top_grad">
         
</div>
<div id="tab">
        <a href="http://twistedmatrix.com/trac/wiki">HOME</a>
    <a href="http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions">FAQ</a>
    <a href="/">DOCS</a>
    <a href="http://twistedmatrix.com/trac/wiki/Downloads">DOWNLOAD</a>

</div>
      <div id="header">
        <a id="logo" href="http://twistedmatrix.com/trac/"><img src="../../_static/trac_banner.png" alt="Twisted" /></a>
      </div>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <form id="topsearch" action="/trac/search" method="get"><div>
        <label for="proj-search">Search:</label>
        <input type="text" id="proj-search" name="q" size="10" value="" />
        <input type="submit" value="Search" />
        <input type="hidden" name="wiki" value="on" />

        <input type="hidden" name="changeset" value="on" />
        <input type="hidden" name="ticket" value="on" />
      </div></form>
      -->
      <div id="metanav" class="nav">
    <ul>
      <li> </li>
      <!-- taking this out for now, but might use 
           the space for something else later 
      -->
      <!--
      <li class="first">logged in as khorn</li><li class=""><a href="/trac/logout">Logout</a></li><li class=""><a href="/trac/wiki/TracGuide">Help/Guide</a></li><li class=""><a href="/trac/about">About Trac</a></li><li class="last"><a href="/trac/account">My Account</a></li>
      -->
    </ul>
  </div>
    </div>

<!-- mainnav -->
    <div id="mainnav" class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="components.html" title="Components: Interfaces and Adapters"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="choosing-reactor.html" title="Choosing a Reactor and GUI Toolkit Integration"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Twisted 17.1.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Twisted Core</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Developer Guides</a> &raquo;</li> 
      </ul>
    </div>

    <div id="main">
    <div id="ctxtnav" class="nav">
      <h2>Wiki Navigation</h2>
      <ul>
        <li>
        
        </li>
        <!-- taking this out for now, but might use 
             the space for something else later 
        -->
        <!--
        <li><a href="/trac/wiki/WikiStart">Start Page</a></li>
        <li><a href="/trac/wiki/TitleIndex">Index by Title</a></li>

        <li><a href="/trac/wiki/RecentChanges">Index by Date</a></li>
        <li class="last">
          <a href="/trac/wiki/Documentation?action=diff&amp;version=15">Last Change</a>
        </li>
        -->
      </ul>
      <hr />
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div id="current-docs-container" style="display: none">
            <em>
              <a id="current-docs-link">
                Go to the latest version of this document.
              </a>
            </em>
          </div>
          <div class="body">
            
  <div class="section" id="getting-connected-with-endpoints">
<h1>Getting Connected with Endpoints<a class="headerlink" href="#getting-connected-with-endpoints" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>On a network, one can think of any given connection as a long wire, stretched between two points.
Lots of stuff can happen along the length of that wire - routers, switches, network address translation, and so on, but that is usually invisible to the application passing data across it.
Twisted strives to make the nature of the &#8220;wire&#8221; as transparent as possible, with highly abstract interfaces for passing and receiving data, such as <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.ITransport.html">ITransport</a> and <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IProtocol.html">IProtocol</a>.</p>
<p>However, the application can&#8217;t be completely ignorant of the wire.
In particular, it must do something to <em>start</em> the connection, and
to do so, it must identify the <em>end points</em> of the wire. There are
different names for the roles of each end point - &#8220;initiator&#8221; and
&#8220;responder&#8221;, &#8220;connector&#8221; and &#8220;listener&#8221;, or &#8220;client&#8221; and &#8220;server&#8221; - but the
common theme is that one side of the connection waits around for someone to
connect to it, and the other side does the connecting.</p>
<p>In Twisted 10.1, several new interfaces were introduced to describe each of these roles for stream-oriented connections: <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IStreamServerEndpoint.html">IStreamServerEndpoint</a> and <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IStreamClientEndpoint.html">IStreamClientEndpoint</a>.
The word &#8220;stream&#8221;, in this case, refers to endpoints which treat a connection as a continuous stream of bytes, rather than a sequence of discrete datagrams:
TCP is a &#8220;stream&#8221; protocol whereas UDP is a &#8220;datagram&#8221; protocol.</p>
</div>
<div class="section" id="constructing-and-using-endpoints">
<h2>Constructing and Using Endpoints<a class="headerlink" href="#constructing-and-using-endpoints" title="Permalink to this headline">¶</a></h2>
<p>In both <a class="reference internal" href="servers.html"><span class="doc">Writing Servers</span></a> and <a class="reference internal" href="clients.html"><span class="doc">Writing Clients</span></a>, we covered basic usage of endpoints;
you construct an appropriate type of server or client endpoint, and then call <code class="docutils literal"><span class="pre">listen</span></code> (for servers) or <code class="docutils literal"><span class="pre">connect</span></code> (for clients).</p>
<p>In both of those tutorials, we constructed specific types of endpoints directly.
However, in most programs, you will want to allow the user to specify where to listen or connect, in a way which will allow the user to request different strategies, without having to adjust your program.
In order to allow this, you should use <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.clientFromString.html">clientFromString</a> or <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.serverFromString.html">serverFromString</a>.</p>
<div class="section" id="there-s-not-much-to-it">
<h3>There&#8217;s Not Much To It<a class="headerlink" href="#there-s-not-much-to-it" title="Permalink to this headline">¶</a></h3>
<p>Each type of endpoint is just an interface with a single method that
takes an argument. <code class="docutils literal"><span class="pre">serverEndpoint.listen(factory)</span></code> will start
listening on that endpoint with your protocol factory, and <code class="docutils literal"><span class="pre">clientEndpoint.connect(factory)</span></code> will start a single connection
attempt. Each of these APIs returns a value, though, which can be important.</p>
<p>However, if you are not already, you <em>should</em> be very familiar with <a class="reference internal" href="defer.html"><span class="doc">Deferreds</span></a>, as they are returned by both <code class="docutils literal"><span class="pre">connect</span></code> and <code class="docutils literal"><span class="pre">listen</span></code> methods, to indicate when the connection has connected or the listening port is up and running.</p>
</div>
<div class="section" id="servers-and-stopping">
<h3>Servers and Stopping<a class="headerlink" href="#servers-and-stopping" title="Permalink to this headline">¶</a></h3>
<p><a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IStreamServerEndpoint.listen.html">IStreamServerEndpoint.listen</a> returns a <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.defer.Deferred.html">Deferred</a> that fires with an <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IListeningPort.html">IListeningPort</a>.
Note that this deferred may errback.
The most common cause of such an error would be that another program is already using the requested port number, but the exact cause may vary depending on what type of endpoint you are listening on.
If you receive such an error, it means that your application is not actually listening, and will not receive any incoming connections.
It&#8217;s important to somehow alert an administrator of your server, in this case, especially if you only have one listening port!</p>
<p>Note also that once this has succeeded, it will continue listening forever.
If you need to <em>stop</em> listening for some reason, in response to anything other than a full server shutdown (<code class="docutils literal"><span class="pre">reactor.stop</span></code> and / or <code class="docutils literal"><span class="pre">twistd</span></code> will usually handle that case for you), make sure you keep a reference around to that listening port object so you can call <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IListeningPort.stopListening.html">IListeningPort.stopListening</a> on it.
Finally, keep in mind that <code class="docutils literal"><span class="pre">stopListening</span></code> itself returns a <code class="docutils literal"><span class="pre">Deferred</span></code>, and the port may not have fully stopped listening until that <code class="docutils literal"><span class="pre">Deferred</span></code> has fired.</p>
<p>Most server applications will not need to worry about these details.
One example of a case where you would need to be concerned with all of these events would be an implementation of a protocol like non-<code class="docutils literal"><span class="pre">PASV</span></code> FTP, where new listening ports need to be bound for the lifetime of a particular action, then disposed of.</p>
</div>
<div class="section" id="clients-and-cancelling">
<h3>Clients and Cancelling<a class="headerlink" href="#clients-and-cancelling" title="Permalink to this headline">¶</a></h3>
<p><a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.connectProtocol.html">connectProtocol</a> connects a <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.protocol.Protocol.html">Protocol</a> instance to a given <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IStreamClientEndpoint.html">IStreamClientEndpoint</a>. It returns a <code class="docutils literal"><span class="pre">Deferred</span></code> which fires with the <code class="docutils literal"><span class="pre">Protocol</span></code> once the connection has been made.
Connection attempts may fail, and so that <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.defer.Deferred.html">Deferred</a> may also errback.
If it does so, you will have to try again; no further attempts will be made.
See the <a class="reference internal" href="clients.html"><span class="doc">client documentation</span></a> for an example use.</p>
<p><a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.connectProtocol.html">connectProtocol</a> is a wrapper around a lower-level API:
<a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IStreamClientEndpoint.connect.html">IStreamClientEndpoint.connect</a> will use a protocol factory for a new outgoing connection attempt.
It returns a <code class="docutils literal"><span class="pre">Deferred</span></code> which fires with the <code class="docutils literal"><span class="pre">IProtocol</span></code> returned from the factory&#8217;s <code class="docutils literal"><span class="pre">buildProtocol</span></code> method, or errbacks with the connection failure.</p>
<p>Connection attempts may also take a long time, and your users may become bored and wander off.
If this happens, and your code decides, for whatever reason, that you&#8217;ve been waiting for the connection too long, you can call <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.defer.Deferred.cancel.html">Deferred.cancel</a> on the <code class="docutils literal"><span class="pre">Deferred</span></code> returned from <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IStreamClientEndpoint.connect.html">connect</a> or <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.connectProtocol.html">connectProtocol</a>, and the underlying machinery should give up on the connection.
This should cause the <code class="docutils literal"><span class="pre">Deferred</span></code> to errback, usually with <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.defer.CancelledError.html">CancelledError</a>;
although you should consult the documentation for your particular endpoint type to see if it may do something different.</p>
<p>Although some endpoint types may imply a built-in timeout, the
interface does not guarantee one. If you don&#8217;t have any way for the
application to cancel a wayward connection attempt, the attempt may just
keep waiting forever.  For example, a very simple 30-second timeout could be
implemented like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">attempt</span> <span class="o">=</span> <span class="n">connectProtocol</span><span class="p">(</span><span class="n">myEndpoint</span><span class="p">,</span> <span class="n">myProtocol</span><span class="p">)</span>
<span class="n">reactor</span><span class="o">.</span><span class="n">callLater</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">attempt</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;ve used <code class="docutils literal"><span class="pre">ClientFactory</span></code> before, keep in mind that the <code class="docutils literal"><span class="pre">connect</span></code> method takes a <code class="docutils literal"><span class="pre">Factory</span></code>, not a <code class="docutils literal"><span class="pre">ClientFactory</span></code>.
Even if you pass a <code class="docutils literal"><span class="pre">ClientFactory</span></code> to <code class="docutils literal"><span class="pre">endpoint.connect</span></code>, its <code class="docutils literal"><span class="pre">clientConnectionFailed</span></code> and <code class="docutils literal"><span class="pre">clientConnectionLost</span></code> methods will not be called.
In particular, clients that extend <code class="docutils literal"><span class="pre">ReconnectingClientFactory</span></code> won&#8217;t reconnect. The next section describes how to set up reconnecting clients on endpoints.</p>
</div>
</div>
<div class="section" id="persistent-client-connections">
<h3>Persistent Client Connections<a class="headerlink" href="#persistent-client-connections" title="Permalink to this headline">¶</a></h3>
<p><a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.application.internet.ClientService.html">twisted.application.internet.ClientService</a> can maintain a persistent outgoing connection to a server which can be started and stopped along with your application.</p>
<p>One popular protocol to maintain a long-lived client connection to is IRC, so for an example of <code class="docutils literal"><span class="pre">ClientService</span></code>, here&#8217;s how you would make a long-lived encrypted connection to an IRC server (other details, like how to authenticate, omitted for brevity):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">Factory</span>
<span class="kn">from</span> <span class="nn">twisted.internet.endpoints</span> <span class="kn">import</span> <span class="n">clientFromString</span>
<span class="kn">from</span> <span class="nn">twisted.words.protocols.irc</span> <span class="kn">import</span> <span class="n">IRCClient</span>
<span class="kn">from</span> <span class="nn">twisted.application.internet</span> <span class="kn">import</span> <span class="n">ClientService</span>
<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">reactor</span>

<span class="n">myEndpoint</span> <span class="o">=</span> <span class="n">clientFromString</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;tls:example.com:6997&quot;</span><span class="p">)</span>
<span class="n">myFactory</span> <span class="o">=</span> <span class="n">Factory</span><span class="o">.</span><span class="n">forProtocol</span><span class="p">(</span><span class="n">IRCClient</span><span class="p">)</span>

<span class="n">myReconnectingService</span> <span class="o">=</span> <span class="n">ClientService</span><span class="p">(</span><span class="n">myEndpoint</span><span class="p">,</span> <span class="n">myFactory</span><span class="p">)</span>
</pre></div>
</div>
<p>If you already have a parent service, you can add the reconnecting service as a child service:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">parentService</span><span class="o">.</span><span class="n">addService</span><span class="p">(</span><span class="n">myReconnectingService</span><span class="p">)</span>
</pre></div>
</div>
<p>If you do not have a parent service, you can start and stop the reconnecting service using its <code class="docutils literal"><span class="pre">startService</span></code> and <code class="docutils literal"><span class="pre">stopService</span></code> methods.</p>
<p><code class="docutils literal"><span class="pre">ClientService.stopService</span></code> returns a <code class="docutils literal"><span class="pre">Deferred</span></code> that fires once the current connection closes or the current connection attempt is cancelled.</p>
</div>
</div>
<div class="section" id="getting-the-active-client">
<h2>Getting The Active Client<a class="headerlink" href="#getting-the-active-client" title="Permalink to this headline">¶</a></h2>
<p>When maintaining a long-lived connection, it&#8217;s often useful to be able to get the current connection (if the connection is active) or wait for the next connection (if a connection attempt is currently in progress).
For example, we might want to pass our <code class="docutils literal"><span class="pre">ClientService</span></code> from the previous example to some code that can send IRC notifications in response to some external event.
The <code class="docutils literal"><span class="pre">ClientService.whenConnected</span></code> method returns a <code class="docutils literal"><span class="pre">Deferred</span></code> that fires with the next available <code class="docutils literal"><span class="pre">Protocol</span></code> instance.
You can use it like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">waitForConnection</span> <span class="o">=</span> <span class="n">myReconnectingService</span><span class="o">.</span><span class="n">whenConnected</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">connectedNow</span><span class="p">(</span><span class="n">clientForIRC</span><span class="p">):</span>
    <span class="n">clientForIRC</span><span class="o">.</span><span class="n">say</span><span class="p">(</span><span class="s2">&quot;#bot-test&quot;</span><span class="p">,</span> <span class="s2">&quot;hello, world!&quot;</span><span class="p">)</span>
<span class="n">waitForConnection</span><span class="o">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">connectedNow</span><span class="p">)</span>
</pre></div>
</div>
<p>Keep in mind that you may need to wrap this up for your particular application, since when no existing connection is available, the callback is executed just as soon as the connection is established.
For example, that little snippet is slightly oversimplified: at the time <code class="docutils literal"><span class="pre">connectedNow</span></code> is run, the bot hasn&#8217;t authenticated or joined the channel yet, so its message will be refused.
A real-life IRC bot would need to have its own method for waiting until the connection is fully ready for chat before chatting.</p>
</div>
<div class="section" id="retry-policies">
<h2>Retry Policies<a class="headerlink" href="#retry-policies" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">ClientService</span></code> will immediately attempt an outgoing connection when <code class="docutils literal"><span class="pre">startService</span></code> is called.
If that connection attempt fails for any reason (name resolution, connection refused, network unreachable, and so on), it will retry according to the policy specified in the <code class="docutils literal"><span class="pre">retryPolicy</span></code> constructor argument.
By default, <code class="docutils literal"><span class="pre">ClientService</span></code> will use an exponential backoff algorithm with a minimum delay of 1 second and a maximum delay of 1 minute, and a jitter of up to 1 additional second to prevent stampeding-herd performance cascades.
This is a good default, and if you do not have highly specialized requirements, you probably want to use it.
If you need to tune these parameters, you have two options:</p>
<ol class="arabic">
<li><p class="first">You can pass your own timeout policy to <code class="docutils literal"><span class="pre">ClientService</span></code>&#8216;s constructor.
A timeout policy is a callable that takes the number of failed attempts, and computes a delay until the next connection attempt.
So, for example, if you are <em>really really sure</em> that you want to reconnect <em>every single second</em> if the service you are talking to goes down, you can do this:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">myReconnectingService</span> <span class="o">=</span> <span class="n">ClientService</span><span class="p">(</span><span class="n">myEndpoint</span><span class="p">,</span> <span class="n">myFactory</span><span class="p">,</span> <span class="n">retryPolicy</span><span class="o">=</span><span class="k">lambda</span> <span class="n">ignored</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Of course, unless you have only one client and only one server and they&#8217;re both on localhost, this sort of policy is likely to cause massive performance degradation and thundering herd resource contention in the event of your server&#8217;s failure, so you probably want to take the second option...</p>
</li>
<li><p class="first">You can tweak the default exponential backoff policy with a few parameters by passing the result of <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.application.internet.backoffPolicy.html">twisted.application.internet.backoffPolicy</a> to the <code class="docutils literal"><span class="pre">retryPolicy</span></code> argument.
For example, if you want to make it triple the delay between attempts, but start with a faster connection interval (half a second instead of one second), you could do it like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">myReconnectingService</span> <span class="o">=</span> <span class="n">ClientService</span><span class="p">(</span>
    <span class="n">myEndpoint</span><span class="p">,</span> <span class="n">myFactory</span><span class="p">,</span>
    <span class="n">retryPolicy</span><span class="o">=</span><span class="n">backoffPolicy</span><span class="p">(</span><span class="n">initialDelay</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Before endpoints, reconnecting clients were created as subclasses of <code class="docutils literal"><span class="pre">ReconnectingClientFactory</span></code>.
These subclasses were required to call <code class="docutils literal"><span class="pre">resetDelay</span></code>.
One of the many advantages of using endpoints is that these special subclasses are no longer needed.
<code class="docutils literal"><span class="pre">ClientService</span></code> accepts ordinary <code class="docutils literal"><span class="pre">IProtocolFactory</span></code> providers.</p>
</div>
</div>
<div class="section" id="maximizing-the-return-on-your-endpoint-investment">
<h2>Maximizing the Return on your Endpoint Investment<a class="headerlink" href="#maximizing-the-return-on-your-endpoint-investment" title="Permalink to this headline">¶</a></h2>
<p>Directly constructing an endpoint in your application is rarely the
best option, because it ties your application to a particular type of
transport. The strength of the endpoints API is in separating the
construction of the endpoint (figuring out where to connect or listen) and
its activation (actually connecting or listening).</p>
<p>If you are implementing a library that needs to listen for
connections or make outgoing connections, when possible, you should write
your code to accept client and server endpoints as parameters to functions
or to your objects&#8217; constructors. That way, application code that calls
your library can provide whatever endpoints are appropriate.</p>
<p>If you are writing an application and you need to construct endpoints yourself, you can allow users to specify arbitrary endpoints described by a string using the <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.clientFromString.html">clientFromString</a> and <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.endpoints.serverFromString.html">serverFromString</a> APIs.
Since these APIs just take a string, they provide flexibility:
if Twisted adds support for new types of endpoints (for example, IPv6 endpoints, or WebSocket endpoints), your application will automatically be able to take advantage of them with no changes to its code.</p>
<div class="section" id="endpoints-aren-t-always-the-answer">
<h3>Endpoints Aren&#8217;t Always the Answer<a class="headerlink" href="#endpoints-aren-t-always-the-answer" title="Permalink to this headline">¶</a></h3>
<p>For many use-cases, especially the common case of a <code class="docutils literal"><span class="pre">twistd</span></code> plugin which runs a long-running server that just binds a simple port, you might not want to use the endpoints APIs directly.
Instead, you may want to construct an <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.application.service.IService.html">IService</a>, using <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.application.strports.service.html">strports.service</a>, which will fit neatly into the required structure of <a class="reference internal" href="plugin.html"><span class="doc">the twistd plugin API</span></a>.
This doesn&#8217;t give your application much control - the port starts listening at startup and stops listening at shutdown - but it does provide the same flexibility in terms of what type of server endpoint your application will support.</p>
<p>It is, however, almost always preferable to use an endpoint rather than calling a lower-level APIs like <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IReactorTCP.connectTCP.html">connectTCP</a>, <a class="api reference external" href="https://twistedmatrix.com/documents/17.1.0/api/twisted.internet.interfaces.IReactorTCP.listenTCP.html">listenTCP</a>, etc, directly.
By accepting an arbitrary endpoint rather than requiring a specific reactor interface, you leave your application open to lots of interesting transport-layer extensibility for the future.</p>
</div>
</div>
<div class="section" id="endpoint-types-included-with-twisted">
<h2>Endpoint Types Included With Twisted<a class="headerlink" href="#endpoint-types-included-with-twisted" title="Permalink to this headline">¶</a></h2>
<p>The parser used by <code class="docutils literal"><span class="pre">clientFromString</span></code> and <code class="docutils literal"><span class="pre">serverFromString</span></code> is extensible via third-party plugins, so the endpoints available on your system depend on what packages you have installed.
However, Twisted itself includes a set of basic endpoints that will always be available.</p>
<div class="section" id="clients">
<h3>Clients<a class="headerlink" href="#clients" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>TCP</dt>
<dd><p class="first">Supported arguments: <code class="docutils literal"><span class="pre">host</span></code>, <code class="docutils literal"><span class="pre">port</span></code>, <code class="docutils literal"><span class="pre">timeout</span></code>.
<code class="docutils literal"><span class="pre">timeout</span></code> is optional.</p>
<p class="last">For example, <code class="docutils literal"><span class="pre">tcp:host=twistedmatrix.com:port=80:timeout=15</span></code>.</p>
</dd>
<dt>TLS</dt>
<dd><p class="first">Required arguments: <code class="docutils literal"><span class="pre">host</span></code>, <code class="docutils literal"><span class="pre">port</span></code>.</p>
<p>Optional arguments: <code class="docutils literal"><span class="pre">timeout</span></code>, <code class="docutils literal"><span class="pre">bindAddress</span></code>, <code class="docutils literal"><span class="pre">certificate</span></code>, <code class="docutils literal"><span class="pre">privateKey</span></code>, <code class="docutils literal"><span class="pre">trustRoots</span></code>, <code class="docutils literal"><span class="pre">endpoint</span></code>.</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">host</span></code> is a (UTF-8 encoded) hostname to connect to, as well as the host name to verify against.</li>
<li><code class="docutils literal"><span class="pre">port</span></code> is a numeric port number to connect to.</li>
<li><code class="docutils literal"><span class="pre">timeout</span></code> and <code class="docutils literal"><span class="pre">bindAddress</span></code> have the same meaning as the <code class="docutils literal"><span class="pre">timeout</span></code> and <code class="docutils literal"><span class="pre">bindAddress</span></code> for TCP clients.</li>
<li><code class="docutils literal"><span class="pre">certificate</span></code> is the certificate to use for the client; it should be the path name of a PEM file containing a certificate for which <code class="docutils literal"><span class="pre">privateKey</span></code> is the private key.</li>
<li><code class="docutils literal"><span class="pre">privateKey</span></code> is the client&#8217;s private key, matching the certificate specified by <code class="docutils literal"><span class="pre">certificate</span></code>.
It should be the path name of a PEM file containing an X.509 client certificate.
If <code class="docutils literal"><span class="pre">certificate</span></code> is specified but <code class="docutils literal"><span class="pre">privateKey</span></code> is unspecified, Twisted will look for the certificate in the same file as specified by <code class="docutils literal"><span class="pre">certificate</span></code>.</li>
<li><code class="docutils literal"><span class="pre">trustRoots</span></code> specifies a path to a directory of PEM-encoded certificate files.  If you leave this unspecified, Twisted will do its best to use the platform default set of trust roots, which should be the default WebTrust set.</li>
<li>the optional <code class="docutils literal"><span class="pre">endpoint</span></code> parameter changes the meaning of the <code class="docutils literal"><span class="pre">tls:</span></code> endpoint slightly.
Rather than the default of connecting over TCP with the same hostname used for verification, you can connect over <em>any</em> endpoint type.
If you specify the endpoint here, <code class="docutils literal"><span class="pre">host</span></code> and <code class="docutils literal"><span class="pre">port</span></code> are used for certificate verification purposes only.
Bear in mind you will need to backslash-escape the colons in the endpoint description here.</li>
</ul>
<p>This client connects to the supplied hostname, validates the server&#8217;s hostname against the supplied hostname, and then upgrades to TLS immediately after validation succeeds.</p>
<p>The simplest example of this would be: <code class="docutils literal"><span class="pre">tls:example.com:443</span></code>.</p>
<p>You can use the <code class="docutils literal"><span class="pre">endpoint:</span></code> feature with TCP if you want to connect to a host name; for example, if your DNS is not working, but you know that the IP address 7.6.5.4 points to <code class="docutils literal"><span class="pre">awesome.site.example.com</span></code>, you could specify: <code class="docutils literal"><span class="pre">tls:awesome.site.example.com:443:endpoint=tcp\:7.6.5.4\:443</span></code>.</p>
<p>You can use it with any other endpoint type as well, though; for example, if you had a local UNIX socket that established a tunnel to <code class="docutils literal"><span class="pre">awesome.site.example.com</span></code> in <code class="docutils literal"><span class="pre">/var/run/awesome.sock</span></code>, you could instead do <code class="docutils literal"><span class="pre">tls:awesome.site.example.com:443:endpoint=unix\:/var/run/awesome.sock</span></code>.</p>
<p>Or, from python code:</p>
<div class="last highlight-default"><div class="highlight"><pre><span></span><span class="n">wrapped</span> <span class="o">=</span> <span class="n">HostnameEndpoint</span><span class="p">(</span><span class="s1">&#39;example.com&#39;</span><span class="p">,</span> <span class="mi">443</span><span class="p">)</span>
<span class="n">contextFactory</span> <span class="o">=</span> <span class="n">optionsForClientTLS</span><span class="p">(</span><span class="n">hostname</span><span class="o">=</span><span class="s1">u&#39;example.com&#39;</span><span class="p">)</span>
<span class="n">endpoint</span> <span class="o">=</span> <span class="n">wrapClientTLS</span><span class="p">(</span><span class="n">contextFactory</span><span class="p">,</span> <span class="n">wrapped</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Factory</span><span class="o">.</span><span class="n">forProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">))</span>
</pre></div>
</div>
</dd>
<dt>UNIX</dt>
<dd><p class="first">Supported arguments: <code class="docutils literal"><span class="pre">path</span></code>, <code class="docutils literal"><span class="pre">timeout</span></code>, <code class="docutils literal"><span class="pre">checkPID</span></code>.
<code class="docutils literal"><span class="pre">path</span></code> gives a filesystem path to a listening UNIX domain socket server.
<code class="docutils literal"><span class="pre">checkPID</span></code> (optional) enables a check of the lock file Twisted-based UNIX domain socket servers use to prove they are still running.</p>
<p class="last">For example, <code class="docutils literal"><span class="pre">unix:path=/var/run/web.sock</span></code>.</p>
</dd>
<dt>TCP (Hostname)</dt>
<dd><p class="first">Supported arguments: <code class="docutils literal"><span class="pre">host</span></code>, <code class="docutils literal"><span class="pre">port</span></code>, <code class="docutils literal"><span class="pre">timeout</span></code>.
<code class="docutils literal"><span class="pre">host</span></code> is a hostname to connect to.
<code class="docutils literal"><span class="pre">timeout</span></code> is optional.
It is a name-based TCP endpoint that returns the connection which is established first amongst the resolved addresses.</p>
<p>For example,</p>
<div class="last highlight-python"><div class="highlight"><pre><span></span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">HostnameEndpoint</span><span class="p">(</span><span class="n">reactor</span><span class="p">,</span> <span class="s2">&quot;twistedmatrix.com&quot;</span><span class="p">,</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">Factory</span><span class="o">.</span><span class="n">forProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">))</span>
</pre></div>
</div>
</dd>
</dl>
<p>SSL (Deprecated)</p>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You should generally prefer the &#8220;TLS&#8221; client endpoint, above, unless you need to work with versions of Twisted older than 16.0.
Among other things:</p>
<blockquote class="last">
<div><ul class="simple">
<li>the <code class="docutils literal"><span class="pre">ssl:</span></code> client endpoint requires that you pass &#8216;&#8217;both&#8217;&#8217; <code class="docutils literal"><span class="pre">hostname=</span></code> (for hostname verification) as well as <code class="docutils literal"><span class="pre">host=</span></code> (for a TCP connection address) in order to get hostname verification, which is required for security, whereas <code class="docutils literal"><span class="pre">tls:</span></code> does the correct thing by default by using the same hostname for both.</li>
<li>the <code class="docutils literal"><span class="pre">ssl:</span></code> client endpoint doesn&#8217;t work with IPv6, and the <code class="docutils literal"><span class="pre">tls:</span></code> endpoint does.</li>
</ul>
</div></blockquote>
</div>
<p>All TCP arguments are supported, plus: <code class="docutils literal"><span class="pre">certKey</span></code>, <code class="docutils literal"><span class="pre">privateKey</span></code>, <code class="docutils literal"><span class="pre">caCertsDir</span></code>.
<code class="docutils literal"><span class="pre">certKey</span></code> (optional) gives a filesystem path to a certificate (PEM format).
<code class="docutils literal"><span class="pre">privateKey</span></code> (optional) gives a filesystem path to a private key (PEM format).
<code class="docutils literal"><span class="pre">caCertsDir</span></code> (optional) gives a filesystem path to a directory containing trusted CA certificates to use to verify the server certificate.</p>
<p>For example, <code class="docutils literal"><span class="pre">ssl:host=twistedmatrix.com:port=443:caCertsDir=/etc/ssl/certs</span></code>.</p>
</div></blockquote>
</div>
<div class="section" id="servers">
<h3>Servers<a class="headerlink" href="#servers" title="Permalink to this headline">¶</a></h3>
<dl class="docutils">
<dt>TCP (IPv4)</dt>
<dd><p class="first">Supported arguments: <code class="docutils literal"><span class="pre">port</span></code>, <code class="docutils literal"><span class="pre">interface</span></code>, <code class="docutils literal"><span class="pre">backlog</span></code>.
<code class="docutils literal"><span class="pre">interface</span></code> and <code class="docutils literal"><span class="pre">backlog</span></code> are optional.
<code class="docutils literal"><span class="pre">interface</span></code> is an IP address (belonging to the IPv4 address family) to bind to.</p>
<p class="last">For example, <code class="docutils literal"><span class="pre">tcp:port=80:interface=192.168.1.1</span></code>.</p>
</dd>
<dt>TCP (IPv6)</dt>
<dd><p class="first">All TCP (IPv4) arguments are supported, with <code class="docutils literal"><span class="pre">interface</span></code> taking an IPv6 address literal instead.</p>
<p class="last">For example, <code class="docutils literal"><span class="pre">tcp6:port=80:interface=2001\:0DB8\:f00e\:eb00\:\:1</span></code>.</p>
</dd>
<dt>SSL</dt>
<dd><p class="first">All TCP arguments are supported, plus: <code class="docutils literal"><span class="pre">certKey</span></code>, <code class="docutils literal"><span class="pre">privateKey</span></code>, <code class="docutils literal"><span class="pre">extraCertChain</span></code>, <code class="docutils literal"><span class="pre">sslmethod</span></code>, and <code class="docutils literal"><span class="pre">dhParameters</span></code>.
<code class="docutils literal"><span class="pre">certKey</span></code> (optional, defaults to the value of privateKey) gives a filesystem path to a certificate (PEM format).
<code class="docutils literal"><span class="pre">privateKey</span></code> gives a filesystem path to a private key (PEM format).
<code class="docutils literal"><span class="pre">extraCertChain</span></code> gives a filesystem path to a file with one or more concatenated certificates in PEM format that establish the chain from a root CA to the one that signed your certificate.
<code class="docutils literal"><span class="pre">sslmethod</span></code> indicates which SSL/TLS version to use (a value like <code class="docutils literal"><span class="pre">TLSv1_METHOD</span></code>).
<code class="docutils literal"><span class="pre">dhParameters</span></code> gives a filesystem path to a file in PEM format with parameters that are required for Diffie-Hellman key exchange.
Since the this is required for the <code class="docutils literal"><span class="pre">DHE</span></code>-family of ciphers that offer perfect forward secrecy (PFS), it is recommended to specify one.
Such a file can be created using <code class="docutils literal"><span class="pre">openssl</span> <span class="pre">dhparam</span> <span class="pre">-out</span> <span class="pre">dh_param_1024.pem</span> <span class="pre">-2</span> <span class="pre">1024</span></code>.
Please refer to <a class="reference external" href="http://www.openssl.org/docs/apps/dhparam.html">OpenSSL&#8217;s documentation on dhparam</a> for further details.</p>
<p class="last">For example, <code class="docutils literal"><span class="pre">ssl:port=443:privateKey=/etc/ssl/server.pem:extraCertChain=/etc/ssl/chain.pem:sslmethod=SSLv3_METHOD:dhParameters=dh_param_1024.pem</span></code>.</p>
</dd>
<dt>UNIX</dt>
<dd><p class="first">Supported arguments: <code class="docutils literal"><span class="pre">address</span></code>, <code class="docutils literal"><span class="pre">mode</span></code>, <code class="docutils literal"><span class="pre">backlog</span></code>, <code class="docutils literal"><span class="pre">lockfile</span></code>.
<code class="docutils literal"><span class="pre">address</span></code> gives a filesystem path to listen on with a UNIX domain socket server.
<code class="docutils literal"><span class="pre">mode</span></code> (optional) gives the filesystem permission/mode (in octal) to apply to that socket.
<code class="docutils literal"><span class="pre">lockfile</span></code> enables use of a separate lock file to prove the server is still running.</p>
<p class="last">For example, <code class="docutils literal"><span class="pre">unix:address=/var/run/web.sock:lockfile=1</span></code>.</p>
</dd>
<dt>systemd</dt>
<dd><p class="first">Supported arguments: <code class="docutils literal"><span class="pre">domain</span></code>, <code class="docutils literal"><span class="pre">index</span></code>.
<code class="docutils literal"><span class="pre">domain</span></code> indicates which socket domain the inherited file descriptor belongs to (eg INET, INET6).
<code class="docutils literal"><span class="pre">index</span></code> indicates an offset into the array of file descriptors which have been inherited from systemd.</p>
<p>For example, <code class="docutils literal"><span class="pre">systemd:domain=INET6:index=3</span></code>.</p>
<p class="last">See also <a class="reference internal" href="systemd.html"><span class="doc">Deploying Twisted with systemd</span></a>.</p>
</dd>
<dt>PROXY</dt>
<dd><p class="first">The PROXY protocol is a stream wrapper and can be applied any of the other server endpoints by placing <code class="docutils literal"><span class="pre">haproxy:</span></code> in front of a normal port definition.</p>
<p>For example, <code class="docutils literal"><span class="pre">haproxy:tcp:port=80:interface=192.168.1.1</span></code> or <code class="docutils literal"><span class="pre">haproxy:ssl:port=443:privateKey=/etc/ssl/server.pem:extraCertChain=/etc/ssl/chain.pem:sslmethod=SSLv3_METHOD:dhParameters=dh_param_1024.pem</span></code>.</p>
<p class="last">The PROXY protocol provides a way for load balancers and reverse proxies to send down the real IP of a connection&#8217;s source and destination without relying on X-Forwarded-For headers. A Twisted service using this endpoint wrapper must run behind a service that sends valid PROXY protocol headers. For more on the protocol see <a class="reference external" href="http://www.haproxy.org/download/1.5/doc/proxy-protocol.txt">the formal specification</a>. Both version one and two of the protocol are currently supported.</p>
</dd>
</dl>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="../../index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="#">Getting Connected with Endpoints</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#constructing-and-using-endpoints">Constructing and Using Endpoints</a><ul>
<li><a class="reference internal" href="#there-s-not-much-to-it">There&#8217;s Not Much To It</a></li>
<li><a class="reference internal" href="#servers-and-stopping">Servers and Stopping</a></li>
<li><a class="reference internal" href="#clients-and-cancelling">Clients and Cancelling</a></li>
<li><a class="reference internal" href="#persistent-client-connections">Persistent Client Connections</a></li>
</ul>
</li>
<li><a class="reference internal" href="#getting-the-active-client">Getting The Active Client</a></li>
<li><a class="reference internal" href="#retry-policies">Retry Policies</a></li>
<li><a class="reference internal" href="#maximizing-the-return-on-your-endpoint-investment">Maximizing the Return on your Endpoint Investment</a><ul>
<li><a class="reference internal" href="#endpoints-aren-t-always-the-answer">Endpoints Aren&#8217;t Always the Answer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#endpoint-types-included-with-twisted">Endpoint Types Included With Twisted</a><ul>
<li><a class="reference internal" href="#clients">Clients</a></li>
<li><a class="reference internal" href="#servers">Servers</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="choosing-reactor.html"
                                  title="previous chapter">Choosing a Reactor and GUI Toolkit Integration</a></p>
            <h4>Next topic</h4>
            <p class="topless"><a href="components.html"
                                  title="next chapter">Components: Interfaces and Adapters</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="../../_sources/core/howto/endpoints.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="../../search.html" method="get">
                <p>
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
                </p>
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>

    </div>
    <div id="footer"><hr />
      <div>

</div>
      <p class="left2">
        Site design<br />
        By <a href="http://huw.ugbox.net/">huw.wilkins.</a>

      </p>
      <p class="right"></p>
    </div>
    <script type="text/javascript">
      if (window.location.pathname.indexOf('/current/') == -1) {
          <!-- Give the user a link to this page, but in the current version of the docs. -->
          var link = document.getElementById('current-docs-link');
          link.href = window.location.pathname.replace(/\/\d+\.\d+\.\d+/, '/current');
          <!-- And make it visible -->
          var container = document.getElementById('current-docs-container');
          container.style.display = '';
          delete link;
          delete container;
      }
    </script>
  </body>
</html>